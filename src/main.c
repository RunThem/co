#include "co.h"

#include <libsock.h>
#include <u/u.h>

unsigned char src_main_c[] = {
    0x23, 0x69, 0x6e, 0x63, 0x6c, 0x75, 0x64, 0x65, 0x20, 0x22, 0x63, 0x6f, 0x2e, 0x68, 0x22, 0x0a,
    0x0a, 0x23, 0x69, 0x6e, 0x63, 0x6c, 0x75, 0x64, 0x65, 0x20, 0x3c, 0x6c, 0x69, 0x62, 0x73, 0x6f,
    0x63, 0x6b, 0x2e, 0x68, 0x3e, 0x0a, 0x23, 0x69, 0x6e, 0x63, 0x6c, 0x75, 0x64, 0x65, 0x20, 0x3c,
    0x73, 0x74, 0x64, 0x61, 0x72, 0x67, 0x2e, 0x68, 0x3e, 0x0a, 0x23, 0x69, 0x6e, 0x63, 0x6c, 0x75,
    0x64, 0x65, 0x20, 0x3c, 0x73, 0x74, 0x64, 0x69, 0x6e, 0x74, 0x2e, 0x68, 0x3e, 0x0a, 0x0a, 0x23,
    0x69, 0x66, 0x64, 0x65, 0x66, 0x20, 0x4e, 0x44, 0x45, 0x42, 0x55, 0x47, 0x0a, 0x23, 0x20, 0x20,
    0x64, 0x65, 0x66, 0x69, 0x6e, 0x65, 0x20, 0x69, 0x6e, 0x66, 0x28, 0x66, 0x6d, 0x74, 0x2c, 0x20,
    0x2e, 0x2e, 0x2e, 0x29, 0x0a, 0x23, 0x65, 0x6c, 0x73, 0x65, 0x0a, 0x23, 0x20, 0x20, 0x69, 0x6e,
    0x63, 0x6c, 0x75, 0x64, 0x65, 0x20, 0x3c, 0x73, 0x74, 0x64, 0x69, 0x6f, 0x2e, 0x68, 0x3e, 0x0a,
    0x23, 0x20, 0x20, 0x64, 0x65, 0x66, 0x69, 0x6e, 0x65, 0x20, 0x69, 0x6e, 0x66, 0x28, 0x66, 0x6d,
    0x74, 0x2c, 0x20, 0x2e, 0x2e, 0x2e, 0x29, 0x20, 0x66, 0x70, 0x72, 0x69, 0x6e, 0x74, 0x66, 0x28,
    0x73, 0x74, 0x64, 0x65, 0x72, 0x72, 0x2c, 0x20, 0x22, 0x5b, 0x6d, 0x61, 0x69, 0x6e, 0x5d, 0x3a,
    0x20, 0x22, 0x20, 0x66, 0x6d, 0x74, 0x20, 0x22, 0x5c, 0x6e, 0x22, 0x20, 0x5f, 0x5f, 0x56, 0x41,
    0x5f, 0x4f, 0x50, 0x54, 0x5f, 0x5f, 0x28, 0x2c, 0x20, 0x29, 0x20, 0x5f, 0x5f, 0x56, 0x41, 0x5f,
    0x41, 0x52, 0x47, 0x53, 0x5f, 0x5f, 0x29, 0x0a, 0x23, 0x65, 0x6e, 0x64, 0x69, 0x66, 0x0a, 0x0a,
    0x76, 0x6f, 0x69, 0x64, 0x20, 0x65, 0x63, 0x68, 0x6f, 0x28, 0x69, 0x6e, 0x74, 0x20, 0x66, 0x64,
    0x29, 0x20, 0x7b, 0x0a, 0x20, 0x20, 0x63, 0x68, 0x61, 0x72, 0x20, 0x62, 0x75, 0x66, 0x5b, 0x31,
    0x30, 0x32, 0x34, 0x5d, 0x20, 0x3d, 0x20, 0x7b, 0x7d, 0x3b, 0x0a, 0x20, 0x20, 0x73, 0x73, 0x69,
    0x7a, 0x65, 0x5f, 0x74, 0x20, 0x73, 0x69, 0x7a, 0x65, 0x20, 0x20, 0x20, 0x3d, 0x20, 0x7b, 0x7d,
    0x3b, 0x0a, 0x0a, 0x20, 0x20, 0x63, 0x68, 0x61, 0x72, 0x20, 0x72, 0x65, 0x73, 0x70, 0x6f, 0x6e,
    0x73, 0x65, 0x5b, 0x5d, 0x20, 0x3d, 0x20, 0x22, 0x48, 0x54, 0x54, 0x50, 0x2f, 0x31, 0x2e, 0x31,
    0x20, 0x32, 0x30, 0x30, 0x20, 0x4f, 0x4b, 0x5c, 0x6e, 0x22, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x22,
    0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x2d, 0x54, 0x79, 0x70, 0x65, 0x3a, 0x20, 0x74, 0x65,
    0x78, 0x74, 0x2f, 0x68, 0x74, 0x6d, 0x6c, 0x3b, 0x20, 0x63, 0x68, 0x61, 0x72, 0x73, 0x65, 0x74,
    0x3d, 0x75, 0x66, 0x74, 0x2d, 0x38, 0x5c, 0x6e, 0x22, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x22, 0x43,
    0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x2d, 0x4c, 0x65, 0x6e, 0x67, 0x74, 0x68, 0x3a, 0x20, 0x31,
    0x33, 0x5c, 0x6e, 0x22, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x22, 0x5c, 0x6e, 0x22, 0x0a, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x22, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x57, 0x6f, 0x72, 0x6c, 0x64, 0x21,
    0x22, 0x3b, 0x0a, 0x0a, 0x20, 0x20, 0x77, 0x68, 0x69, 0x6c, 0x65, 0x20, 0x28, 0x74, 0x72, 0x75,
    0x65, 0x29, 0x20, 0x7b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x73, 0x69, 0x7a, 0x65, 0x20, 0x3d, 0x20,
    0x63, 0x6f, 0x5f, 0x72, 0x65, 0x63, 0x76, 0x28, 0x66, 0x64, 0x2c, 0x20, 0x62, 0x75, 0x66, 0x2c,
    0x20, 0x73, 0x69, 0x7a, 0x65, 0x6f, 0x66, 0x28, 0x62, 0x75, 0x66, 0x29, 0x2c, 0x20, 0x30, 0x29,
    0x3b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x69, 0x6e, 0x66, 0x28, 0x22, 0x72, 0x65, 0x63, 0x76, 0x20,
    0x69, 0x73, 0x20, 0x25, 0x7a, 0x75, 0x22, 0x2c, 0x20, 0x73, 0x69, 0x7a, 0x65, 0x29, 0x3b, 0x0a,
    0x0a, 0x20, 0x20, 0x20, 0x20, 0x69, 0x66, 0x20, 0x28, 0x73, 0x69, 0x7a, 0x65, 0x20, 0x3d, 0x3d,
    0x20, 0x2d, 0x31, 0x20, 0x7c, 0x7c, 0x20, 0x73, 0x69, 0x7a, 0x65, 0x20, 0x3d, 0x3d, 0x20, 0x30,
    0x29, 0x20, 0x7b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x63, 0x6c, 0x6f, 0x73, 0x65, 0x28,
    0x66, 0x64, 0x29, 0x3b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x62, 0x72, 0x65, 0x61, 0x6b,
    0x3b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x7d, 0x0a, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x63, 0x6f, 0x5f,
    0x73, 0x65, 0x6e, 0x64, 0x28, 0x66, 0x64, 0x2c, 0x20, 0x72, 0x65, 0x73, 0x70, 0x6f, 0x6e, 0x73,
    0x65, 0x2c, 0x20, 0x73, 0x69, 0x7a, 0x65, 0x6f, 0x66, 0x28, 0x72, 0x65, 0x73, 0x70, 0x6f, 0x6e,
    0x73, 0x65, 0x29, 0x2c, 0x20, 0x30, 0x29, 0x3b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x2f, 0x2f, 0x20,
    0x77, 0x72, 0x69, 0x74, 0x65, 0x28, 0x66, 0x64, 0x2c, 0x20, 0x72, 0x65, 0x73, 0x70, 0x6f, 0x6e,
    0x73, 0x65, 0x2c, 0x20, 0x73, 0x69, 0x7a, 0x65, 0x6f, 0x66, 0x28, 0x72, 0x65, 0x73, 0x70, 0x6f,
    0x6e, 0x73, 0x65, 0x29, 0x29, 0x3b, 0x0a, 0x20, 0x20, 0x7d, 0x0a, 0x0a, 0x20, 0x20, 0x69, 0x6e,
    0x66, 0x28, 0x22, 0x65, 0x63, 0x68, 0x6f, 0x20, 0x73, 0x69, 0x7a, 0x65, 0x20, 0x69, 0x73, 0x20,
    0x25, 0x7a, 0x75, 0x22, 0x2c, 0x20, 0x73, 0x69, 0x7a, 0x65, 0x29, 0x3b, 0x0a, 0x7d, 0x0a, 0x0a,
    0x76, 0x6f, 0x69, 0x64, 0x20, 0x5f, 0x6d, 0x61, 0x69, 0x6e, 0x28, 0x69, 0x6e, 0x74, 0x20, 0x61,
    0x72, 0x67, 0x63, 0x2c, 0x20, 0x63, 0x6f, 0x6e, 0x73, 0x74, 0x20, 0x63, 0x68, 0x61, 0x72, 0x2a,
    0x20, 0x61, 0x72, 0x67, 0x76, 0x5b, 0x5d, 0x29, 0x20, 0x7b, 0x0a, 0x20, 0x20, 0x69, 0x6e, 0x74,
    0x20, 0x63, 0x66, 0x64, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x3d, 0x20, 0x7b, 0x7d, 0x3b, 0x0a, 0x20, 0x20, 0x73, 0x74, 0x72,
    0x75, 0x63, 0x74, 0x20, 0x73, 0x6f, 0x63, 0x6b, 0x61, 0x64, 0x64, 0x72, 0x5f, 0x69, 0x6e, 0x20,
    0x61, 0x64, 0x64, 0x72, 0x20, 0x3d, 0x20, 0x7b, 0x7d, 0x3b, 0x0a, 0x20, 0x20, 0x73, 0x6f, 0x63,
    0x6b, 0x6c, 0x65, 0x6e, 0x5f, 0x74, 0x20, 0x61, 0x64, 0x64, 0x72, 0x5f, 0x6c, 0x65, 0x6e, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x3d, 0x20, 0x7b, 0x7d, 0x3b, 0x0a, 0x20, 0x20, 0x73, 0x6f, 0x63,
    0x6b, 0x5f, 0x63, 0x6f, 0x6e, 0x66, 0x5f, 0x74, 0x20, 0x63, 0x6f, 0x6e, 0x66, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x3d, 0x20, 0x7b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2e, 0x74, 0x79, 0x70, 0x65, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x3d, 0x20, 0x53, 0x4f, 0x43, 0x4b, 0x5f, 0x54, 0x59, 0x50, 0x45, 0x5f, 0x49, 0x4e, 0x45, 0x54,
    0x34, 0x5f, 0x54, 0x43, 0x50, 0x2c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x2e, 0x68, 0x6f, 0x73, 0x74, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3d, 0x20,
    0x22, 0x30, 0x2e, 0x30, 0x2e, 0x30, 0x2e, 0x30, 0x22, 0x2c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2e, 0x70, 0x6f, 0x72, 0x74, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x3d, 0x20, 0x38, 0x30, 0x38, 0x30, 0x2c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2e, 0x6e, 0x6f, 0x6e, 0x62, 0x6c, 0x6f, 0x63, 0x6b,
    0x20, 0x3d, 0x20, 0x74, 0x72, 0x75, 0x65, 0x2c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2e, 0x6c, 0x69, 0x73, 0x74, 0x65, 0x6e, 0x20, 0x20, 0x20,
    0x3d, 0x20, 0x31, 0x30, 0x30, 0x30, 0x2c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x2e, 0x6f, 0x70, 0x74, 0x73, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3d,
    0x20, 0x7b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7b, 0x2e, 0x6f,
    0x70, 0x74, 0x5f, 0x69, 0x64, 0x20, 0x3d, 0x20, 0x53, 0x4f, 0x5f, 0x52, 0x45, 0x55, 0x53, 0x45,
    0x50, 0x4f, 0x52, 0x54, 0x2c, 0x20, 0x2e, 0x76, 0x61, 0x6c, 0x75, 0x65, 0x20, 0x3d, 0x20, 0x26,
    0x28, 0x69, 0x6e, 0x74, 0x29, 0x7b, 0x31, 0x7d, 0x2c, 0x20, 0x2e, 0x76, 0x61, 0x6c, 0x75, 0x65,
    0x5f, 0x6c, 0x65, 0x6e, 0x20, 0x3d, 0x20, 0x73, 0x69, 0x7a, 0x65, 0x6f, 0x66, 0x28, 0x69, 0x6e,
    0x74, 0x29, 0x7d, 0x2c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7d,
    0x0a, 0x20, 0x20, 0x7d, 0x3b, 0x0a, 0x0a, 0x20, 0x20, 0x73, 0x6f, 0x63, 0x6b, 0x5f, 0x6f, 0x70,
    0x65, 0x6e, 0x28, 0x26, 0x63, 0x6f, 0x6e, 0x66, 0x29, 0x3b, 0x0a, 0x20, 0x20, 0x69, 0x6e, 0x66,
    0x28, 0x22, 0x6c, 0x69, 0x73, 0x74, 0x65, 0x6e, 0x20, 0x25, 0x73, 0x3a, 0x25, 0x64, 0x2c, 0x20,
    0x66, 0x64, 0x20, 0x69, 0x73, 0x20, 0x25, 0x64, 0x22, 0x2c, 0x20, 0x63, 0x6f, 0x6e, 0x66, 0x2e,
    0x68, 0x6f, 0x73, 0x74, 0x2c, 0x20, 0x63, 0x6f, 0x6e, 0x66, 0x2e, 0x70, 0x6f, 0x72, 0x74, 0x2c,
    0x20, 0x63, 0x6f, 0x6e, 0x66, 0x2e, 0x66, 0x64, 0x29, 0x3b, 0x0a, 0x0a, 0x20, 0x20, 0x69, 0x66,
    0x20, 0x28, 0x63, 0x6f, 0x6e, 0x66, 0x2e, 0x66, 0x64, 0x20, 0x3d, 0x3d, 0x20, 0x2d, 0x31, 0x29,
    0x20, 0x7b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x72, 0x65, 0x74, 0x75, 0x72, 0x6e, 0x3b, 0x0a, 0x20,
    0x20, 0x7d, 0x0a, 0x0a, 0x20, 0x20, 0x2f, 0x2f, 0x20, 0x66, 0x6f, 0x72, 0x20, 0x28, 0x69, 0x6e,
    0x74, 0x20, 0x69, 0x20, 0x3d, 0x20, 0x30, 0x3b, 0x20, 0x69, 0x20, 0x3c, 0x20, 0x33, 0x3b, 0x20,
    0x69, 0x2b, 0x2b, 0x29, 0x20, 0x7b, 0x0a, 0x20, 0x20, 0x77, 0x68, 0x69, 0x6c, 0x65, 0x20, 0x28,
    0x74, 0x72, 0x75, 0x65, 0x29, 0x20, 0x7b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x63, 0x66, 0x64, 0x20,
    0x3d, 0x20, 0x63, 0x6f, 0x5f, 0x61, 0x63, 0x63, 0x65, 0x70, 0x74, 0x28, 0x63, 0x6f, 0x6e, 0x66,
    0x2e, 0x66, 0x64, 0x2c, 0x20, 0x28, 0x73, 0x74, 0x72, 0x75, 0x63, 0x74, 0x20, 0x73, 0x6f, 0x63,
    0x6b, 0x61, 0x64, 0x64, 0x72, 0x2a, 0x29, 0x26, 0x61, 0x64, 0x64, 0x72, 0x2c, 0x20, 0x26, 0x61,
    0x64, 0x64, 0x72, 0x5f, 0x6c, 0x65, 0x6e, 0x29, 0x3b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x69, 0x6e,
    0x66, 0x28, 0x22, 0x63, 0x6c, 0x69, 0x65, 0x6e, 0x74, 0x20, 0x69, 0x73, 0x20, 0x25, 0x64, 0x22,
    0x2c, 0x20, 0x63, 0x66, 0x64, 0x29, 0x3b, 0x0a, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x69, 0x66, 0x20,
    0x28, 0x63, 0x6f, 0x6e, 0x66, 0x2e, 0x66, 0x64, 0x20, 0x3d, 0x3d, 0x20, 0x2d, 0x31, 0x29, 0x20,
    0x7b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2f, 0x2f, 0x20, 0x72, 0x65, 0x74, 0x75, 0x72,
    0x6e, 0x3b, 0x0a, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x69, 0x6e, 0x66, 0x28, 0x22, 0x61,
    0x63, 0x63, 0x65, 0x70, 0x74, 0x20, 0x63, 0x6f, 0x6e, 0x74, 0x69, 0x6e, 0x75, 0x65, 0x22, 0x29,
    0x3b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x63, 0x6f, 0x6e, 0x74, 0x69, 0x6e, 0x75, 0x65,
    0x3b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x7d, 0x0a, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x63, 0x6f, 0x5f,
    0x6e, 0x65, 0x77, 0x28, 0x65, 0x63, 0x68, 0x6f, 0x2c, 0x20, 0x63, 0x66, 0x64, 0x29, 0x3b, 0x0a,
    0x20, 0x20, 0x7d, 0x0a, 0x0a, 0x20, 0x20, 0x69, 0x6e, 0x66, 0x28, 0x22, 0x5f, 0x6d, 0x61, 0x69,
    0x6e, 0x20, 0x65, 0x6e, 0x64, 0x22, 0x29, 0x3b, 0x0a, 0x0a, 0x20, 0x20, 0x73, 0x6f, 0x63, 0x6b,
    0x5f, 0x63, 0x6c, 0x6f, 0x73, 0x65, 0x28, 0x26, 0x63, 0x6f, 0x6e, 0x66, 0x29, 0x3b, 0x0a, 0x7d,
    0x0a, 0x0a, 0x69, 0x6e, 0x74, 0x20, 0x6d, 0x61, 0x69, 0x6e, 0x28, 0x69, 0x6e, 0x74, 0x20, 0x61,
    0x72, 0x67, 0x63, 0x2c, 0x20, 0x63, 0x6f, 0x6e, 0x73, 0x74, 0x20, 0x63, 0x68, 0x61, 0x72, 0x2a,
    0x20, 0x61, 0x72, 0x67, 0x76, 0x5b, 0x5d, 0x29, 0x20, 0x7b, 0x0a, 0x20, 0x20, 0x72, 0x65, 0x74,
    0x75, 0x72, 0x6e, 0x20, 0x63, 0x6f, 0x5f, 0x6c, 0x6f, 0x6f, 0x70, 0x28, 0x5f, 0x6d, 0x61, 0x69,
    0x6e, 0x2c, 0x20, 0x61, 0x72, 0x67, 0x63, 0x2c, 0x20, 0x61, 0x72, 0x67, 0x76, 0x29, 0x3b, 0x0a,
    0x7d, 0x0a, 0x00};
unsigned int src_main_c_len = 1842;

void echo(int fd) {
  char buf[1024] = {};
  ssize_t size   = {};

  char res_head[]    = "HTTP/1.1 200 OK\n"
                       "Content-Type: text/html; charset=uft-8\n"
                       "Content-Length: %zu\n"
                       "\n"
                       "%s";
  char res_buf[4096] = {};
  size_t res_size    = snprintf(res_buf, sizeof(res_buf), res_head, src_main_c_len, src_main_c);

  while (true) {
    size = co_recv(fd, buf, sizeof(buf), 0);
    u_inf("recv is %zu", size);

    if (size == -1 || size == 0) {
      close(fd);
      break;
    }

    co_send(fd, res_buf, res_size, 0);
    // write(fd, response, sizeof(response));
  }

  u_inf("echo size is %zu", size);
}

void fun() {
  u_each (i, 1000) {
    co_yield (2);
  }
}

void _main(int argc, const char* argv[]) {

  // u_each(i, 1000) {
  //   co_new(fun);
  // }

#if 1
  int cfd                 = {};
  struct sockaddr_in addr = {};
  socklen_t addr_len      = {};
  sock_conf_t conf        = {
             .type     = SOCK_TYPE_INET4_TCP,
             .host     = "0.0.0.0",
             .port     = 8080,
             .nonblock = true,
             .listen   = 1000,
             .opts     = {
                          {.opt_id = SO_REUSEPORT, .value = &(int){1}, .value_len = sizeof(int)},
                          }
  };

  sock_open(&conf);
  u_inf("listen %s:%d, fd is %d", conf.host, conf.port, conf.fd);

  if (conf.fd == -1) {
    return;
  }

  // for (int i = 0; i < 3; i++) {
  while (true) {
    cfd = co_accept(conf.fd, (struct sockaddr*)&addr, &addr_len);
    u_inf("client is %d", cfd);

    if (conf.fd == -1) {
      // return;

      u_inf("accept continue");
      continue;
    }

    co_new(echo, cfd);
  }

  u_inf("_main end");

  sock_close(&conf);
#endif
}

int main(int argc, const char* argv[]) {
  // u_log_init("/home/iccy/Code/i_c/no_use/co/log.txt");
  u_log_init();
  return co_loop(_main, argc, argv);
}
